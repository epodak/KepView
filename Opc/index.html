<!DOCTYPE html>
<html>
  <head>
    <title>Transit OPC Server Configuration</title>
    <!--Reference xsl tansform. -->
    <script type="text/javascript" src="scripts/m-xml.js"></script>
    <!--Reference the jQuery library. -->
    <script src="Scripts/jquery-2.2.0.min.js"></script>
    <!--Reference the SignalR library. -->
    <script src="Scripts/jquery.signalR-2.2.0.min.js"></script>
    <!--Reference the autogenerated SignalR hub script. -->
    <script src="signalr/hubs"></script>

    <link rel="stylesheet" type="text/css" href="content/flexboxgrid.css">
    <link rel="stylesheet" type="text/css" href="content/site.css">
  </head>
  <body>
    <div data-xml="CurrentOPCServerConfiguration.xml" data-xslt="tables.xsl"></div> 
      <script type="text/javascript">
      window.onload = function() {
        magicXML.parse();
      };
      function opcSubscribe(subscriptions) {
         
        $(function () {
            // Declare a proxy to reference the hub.
            var chat = $.connection.opcHub;
            // Create a function that the hub can call to broadcast messages.
            chat.client.broadcastMessage = function (name, message) {
            	// Html encode display name and message.
				if(message.Succeeded)
					$(".tag-" + message.Node.replace(/\\/g, '\\\\').replace(/\./g, '\\.'))
						.removeClass("good-status bad-status uncertain-status error-status")
						.addClass(message.HasGoodStatus ? "good-status" : "")
						.addClass(message.HasBadStatus ? "bad-status" : "")
						.addClass(message.HasUncertainStatus ? "uncertain-status" : "")
						.text(message.DisplayValue);
				else
					$(".tag-" + message.Node.replace(/\\/g, '\\\\').replace(/\./g, '\\.'))
						.removeClass("good-status bad-status error-status")
						.addClass("error-status")
						.text(message.Exception.substring(0, 80));
               
            };
            // Start the connection.
            $.connection.hub.start().done(function () {
                
            	//var half_length = Math.ceil(subscriptions.length / 2);

            	// Call the Send method on the hub.
            	//var leftSide = subscriptions.splice(0, half_length);
            	chat.server.subscribe(subscriptions);
                
            });
            $.connection.hub.reconnected(function () {
            	chat.server.subscribe(subscriptions);
            });
            $.connection.hub.reconnecting(function () {
            	subscriptions.forEach(function (subscription) {
            		$(".tag-" + subscription.replace(/\\/g, '\\\\').replace(/\./g, '\\.'))
						.removeClass("good-status bad-status error-status")
						.addClass("error-status")
						.text("reconnecting");
            	});
            });
            $.connection.hub.disconnected(function () {
            	subscriptions.forEach(function (subscription) {
            		$(".tag-" + subscription.replace(/\\/g, '\\\\').replace(/\./g, '\\.'))
						.removeClass("good-status bad-status error-status")
						.addClass("error-status")
						.text("disconnected.. ");
            	});
            	setTimeout(function () {
            		subscriptions.forEach(function (subscription) {
            			$(".tag-" + subscription.replace(/\\/g, '\\\\').replace(/\./g, '\\.'))
							.removeClass("good-status bad-status error-status")
							.addClass("error-status")
							.text("disconnected.. reconnecting");
            		});
            		$.connection.hub.start().done(function () {
            			
            			//var half_length = Math.ceil(subscriptions.length / 2);

            			// Call the Send method on the hub.
            			//var leftSide = subscriptions.splice(0, half_length);
            			chat.server.subscribe(subscriptions);

            		});
            	}, 5000); // Restart connection after 5 seconds.
            });
        });
      
      }
    </script>
  </body>
</html>
